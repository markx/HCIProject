<script src="/static/js/jquery.tokeninput.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/token-input.css" />
<link rel="stylesheet" type="text/css" href="/static/css/token-input-facebook.css" />

<script>
  	  var friendlist = new Array();
  	  var i = 0;
  	  var level = 0;
  	  var chooseType = "mannual";
  	  var creditor = "{{user.email}}";
  	  var strInput = "hemizedPrice" + i;
  	  var strInitSample = "sample" + i;
  	  var testNumber = 3;
  	  var friendChosen = [{name:"{{user.get_full_name}}", email:"{{user.email}}"}];
  	  {% for friend in friends %}
  	  	var stringName = "{{friend.get_full_name}}" + i;
  	  	$("#addRow tr:eq(0) td:eq("+testNumber+") input").attr({id:stringName});
  	  	testNumber += 1;
      {% endfor %}



	  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});


  	  $("#fadeBill").click(function(){
  	  		if (friendlist.length == 0) {
		  	  	{% for friend in friends %}
		  	  		var friendname = "{{ friend.get_full_name }}";
              friendlist.push({ 
                email: '{{ friend.email }}', 
                first_name: '{{friend.first_name}}',
                last_name: '{{ friend.last_name }}',
                name: '{{friend.get_full_name }}',
                id: {{ friend.pk }}
              });
		  	  	{% endfor %}
		  	};
	  	  	document.getElementById('datePicker').valueAsDate = new Date();
  	  });

  $(function(){
            $("#peopleInvolved").tokenInput( friendlist ,
                {
                  theme: "facebook",  
                  onAdd: function (item) {
                    var li = $("<li id='li-"+item.id+"' role='presentation'><a role='menuitem' tabindex='-1'>"+ item.name +"</a></li>");
                    $('#menu1').append(li);

                  },
                  onDelete: function (item) {
                    $('#li-'+item.id).remove();
                  } 
                });
            $(".token-input-dropdown-facebook").css("z-index","99999");
  });


	  $("#equalAmount").on("input",function(){
	  	var totalAmount = document.getElementById('equalAmount').value;
	  	var friendsNumber = {{friends|length}};
  	  	$(".perAmountEqual").each(function(){
  	  		this.value = totalAmount/2;
  	  	});
	  });

	  $("#hemized").click(function(){
	  	$("#size").attr("class", "modal-dialog modal-lg"); 
	  	chooseType = "hemized";
	  });

	  $("#equal").click(function(){
	  	$("#size").attr("class", "modal-dialog modal-sm"); 
	  	chooseType="equal";
	  });

	  $("#mannual").click(function(){
	  	$("#size").attr("class", "modal-dialog modal-sm"); 
	  	chooseType = "mannual";
	  });

	  $.custom = {
	  	recursive:function(intI){
	  		$("#addRow tr:eq("+intI+") td:eq(2) input").unbind("input");
	  		$("#addRow tr:eq("+intI+") td:eq(2) input").on("input", function(){
	  			$.updateData(intI);
	  			$.updateTotal();
	  		});
				var strSample = "sample" + intI;
			  	intI += 1;
			  	strInput = "hemizedPrice" + intI;
			  	newSample = "sample" + intI;
			  	$("#"+strSample).clone().attr({id:newSample}).appendTo("#addRow");
			  	$("#addRow tr:eq("+intI+") td:eq(2) input").attr({id:strInput});
			  	document.getElementById(strInput).value = "";
			  	var countNumber = 3;
			  	var strCheckBox = "checkBox";
			  	{% for friend in friends %}
			  		strCheckBox = "{{friend.get_full_name}}" + intI;
			  		$("#addRow tr:eq("+intI+") td:eq("+countNumber+") input").attr({id:strCheckBox});
			  		$("#addRow tr:eq("+intI+") td:eq("+countNumber+") input").attr("row", intI);
			  		countNumber += 1;
			  	{% endfor %}

			  	$("#addRow tr:eq("+intI+") td:eq(2) input").bind("input",function(){
			  		$.custom.recursive(intI);
			  	});
			  	level += 1;
			  	$.updateData(intI);
	  			$.updateTotal();
	  			$.recursiveCheckBox(intI);
	  	}
	  }

	$.extend({
		recursiveCheckBox:function(rowNumber){
			{% for friend in friends %}
				var checkBoxId = "{{friend.get_full_name}}" + rowNumber;
				$("#" + checkBoxId).on("click",function(){
					var valueString = "hemizedPrice" + rowNumber;
	  				var itemPrice = document.getElementById(valueString).value;
	  				var thisId = $(this).attr("id");
	  				var checkBoxValue =  document.getElementById(thisId).value;
	  				if (checkBoxValue == 0 ) {
	  					document.getElementById(thisId).value = 1;
	  				}else{
	  					document.getElementById(thisId).value = 0;
	  				};
	  				$.updateData(rowNumber);
	  				$.updateTotal();
				});
			{% endfor %}
		}
	});

	$.extend({
	  	updateData:function(rowN){
	  		var priceId = "hemizedPrice" + rowN;
	  		var sharedNumber = 0;
	  		{% for friend in friends %}
	  			var friendName = "{{friend.get_full_name}}";
		  		var checkBoxId = friendName + rowN;
		  		var checkValue = $("#"+checkBoxId).attr("value");
		  		if (checkValue != 0) {
		  			sharedNumber += 1;
		  		};
	  		{% endfor %}
	  		var itemPrice = document.getElementById(priceId).value;
	  		var perAmount = itemPrice/sharedNumber;
	  		{% for friend in friends %}
	  			var friendName = "{{friend.get_full_name}}";
	  			var checkBoxId = friendName + rowN;
		  		var checkValue = $("#"+checkBoxId).attr("value");
		  		if (checkValue != 0) {
		  			$("#"+checkBoxId).attr("value", perAmount);
		  		};
	  		{% endfor %}
	  	}
	});

	$.extend({
	  	updateTotal:function(){
	  		document.getElementById("totalAmount").value = "";
	  		var totalAmountNum = 0;
	  		for (var n = level - 1; n >= 0; n--) {
	  			var priceId = "hemizedPrice" + n;
	  			var priceIdString = document.getElementById(priceId).value;
	  			var priceIdNum = Number(priceIdString);
	  			totalAmountNum += priceIdNum;
	  		};
	  		document.getElementById("totalAmount").value = totalAmountNum + "";

	  		{% for friend in friends %}
	  			var friendName = "{{friend.get_full_name}}";
	  			var subtotalId = friendName + "_Amount";

	  			document.getElementById(subtotalId).value = "";
	  			for (var n = level - 1; n >= 0; n--) {
	  				var checkBoxId = friendName + n;
	  				var checkValue = $("#"+checkBoxId).attr("value");
	  				if (checkValue != 0) {
	  					var subtotalIdString =  document.getElementById(subtotalId).value;
	  					if (subtotalIdString == "") {
	  						var checkValueNum = Number(checkValue);
	  						var sumNum = checkValueNum;
	  					}else{
	  						var subtotalIdNum = Number(subtotalIdString);
	  						var checkValueNum = Number(checkValue);
	  						var sumNum = subtotalIdNum + checkValueNum;
	  					};
	  					var sumString = sumNum + "";
		  				document.getElementById(subtotalId).value = sumNum;
		  			};
	  			};
	  		{% endfor %}
	  	}
	});

	$.extend({
		stringSum:function(string1, string2){
			var number1 = Number(string1);
			var number2 = Number(string2);
			var sumNum =  number1 + number2;
			var sumString = sumNum + "";
			return sumString;
		}
	});

	  $(".checkBox").click(function(){
	  	var rowNumber = $(this).attr("row");
	  	var valueString = "hemizedPrice" + rowNumber;
	  	var checkBoxString = $(this).attr("id");
	  	var totalAmount = document.getElementById(valueString).value;
	  	if (this.value == 0) {
	  		this.value = 1;
	  	} else{
	  		this.value = 0;
	  	};
	  	$.updateData(rowNumber);
	  	$.updateTotal();
	  });	

	  $("#addRow tr:eq(0) td:eq(2) input").bind("input", function(){
	  	$.custom.recursive(i);
	  	var rowNumber = 0;
	  	$.updateData(rowNumber);
	  	$.updateTotal();
	  });

	  $("#addBill").click(function(){
	  	var postData = [];
	  	if (chooseType == "mannual") {
	  		$.each(friendChosen, function(n, friend){
	  			if (friend.email != creditor) {
	  				var tabId = "perAmountMannual_" + friend.name;
	  				var amount = document.getElementById(tabId).value;
	  				var billTime = $("#datePicker").val();
	  				var bill = {"creditor":creditor, "debtor":friend.email, "amount":amount, "bill_time":billTime};
	  				postData.push(bill);
	  			};
	  		});
	  	}else if (chooseType == "equal") {
	  		$.each(friendChosen, function(n, friend){
	  			if (friend.email != creditor) {
	  				var tabId = "perAmountEqual_" + friend.name;
	  				var amount = document.getElementById(tabId).value;
	  				var billTime = $("#datePicker").val();
	  				var bill = {"creditor":creditor, "debtor":friend.email, "amount":amount, "bill_time":billTime};
	  				postData.push(bill);
	  			};
	  		});
	  	}else{
	  		$.each(friendChosen, function(n, friend){
	  			if (friend.email != creditor) {
	  				var tabId = friend.name + "_Amount";
	  				var amount = document.getElementById(tabId).value;
	  				var billTime = $("#datePicker").val();
	  				var bill = {"creditor":creditor, "debtor":friend.email, "amount":amount, "bill_time":billTime};
	  				postData.push(bill);
	  			};
	  		});
	  	};

	  	$.post("/bill/new",{bill: postData},function(){
	  		location.reload();
	  	});

	  });

	  $("#cancel").click(function(){
	  	document.getElementById('peopleInvolved').value = "";
	  	document.getElementById('peoplePaid').value = "";
	  });
  </script>
